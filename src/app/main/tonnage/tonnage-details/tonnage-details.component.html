<tonnage-stats *ngIf="tonnage"></tonnage-stats>
<div *ngIf="tonnage">
  <div class="content" *ngIf="habilitation.canEdit()">
    <form
      #specificCarcassForm="ngForm"
      name="tonnageGibletform"
      (ngSubmit)="addSpecificCarcass(specificCarcassForm)"
    >
      <div
        class="mat-elevation-z2 add-panel p-12"
        fxLayoutAlign="space-around center"
        fxLayout.lt-sm="column"
      >
        <div fxFlex="50">
          AJOUTER DES AGNEAUX AU POIDS MOYEN (POIDS MOYEN 18 KG):
        </div>
        <div fxFlex="20">
          <mat-form-field appearance="outline" fxFlex="100">
            <mat-label>Quantité</mat-label>
            <input
              matInput
              name="title"
              type="number"
              [(ngModel)]="specificCarcassAverageWeight"
              required
            />
          </mat-form-field>
        </div>
        <div>
          <button mat-raised-button color="accent" type="submit" [disabled]="tonnage.isValidated">
            Valider
          </button>
        </div>
      </div>
    </form>
  </div>
</div>
<mat-tab-group mat-align-tabs="center" mat-stretch-tabs *ngIf="tonnage">
  <mat-tab label="Carcasses">
    <form
      #f="ngForm"
      name="form"
      (ngSubmit)="addTonnageDetail(f)"
      *ngIf="habilitation.canEdit()"
    >
      <div
        class="mat-elevation-z2 add-panel p-12"
        fxLayoutAlign="space-around center"
        fxLayout.lt-sm="column"
      >
        <div fxFlex="25" fxFlex.lt-sm="100">
          <mat-form-field appearance="outline" fxFlex="100">
            <mat-label>Type</mat-label>
            <mat-select
              required
              name="type"
              [(ngModel)]="newTonnageDetails.itemType"
            >
              <mat-option
                *ngFor="let tonnageItemType of tonnageItemTypes"
                [value]="tonnageItemType"
              >
                {{ tonnageItemType.name }}
              </mat-option>
            </mat-select>
          </mat-form-field>
        </div>
        <div fxFlex="25" fxFlex.lt-sm="100">
          <mat-form-field appearance="outline" fxFlex="100">
            <mat-label>Poids</mat-label>
            <input
              matInput
              name="title"
              type="number"
              [(ngModel)]="newTonnageDetails.weight"
              required
            />
          </mat-form-field>
        </div>
        <div fxFlex="25" fxFlex.lt-sm="100">
          <mat-form-field appearance="outline" fxFlex="100">
            <mat-label>Pourcentage</mat-label>
            <mat-select
              name="percentage"
              [(ngModel)]="newTonnageDetails.percentage"
              required
            >
              <mat-option
                *ngFor="let percentage of possiblePercentage"
                [value]="percentage"
              >
                {{ percentage }}
              </mat-option>
            </mat-select>
          </mat-form-field>
        </div>
        <div fxLayout.lt-sm="column">
          <button
            [disabled]="tonnage.isValidated"
            mat-icon-button
            color="accent"
            class="mat-elevation-z1"
            type="submit"
          >
            <mat-icon>add</mat-icon>
          </button>
          <button
            [disabled]="tonnage.isValidated"
            class="ml-0 ml-sm-8"
            matTooltip="Ajouter tonnage details par poids totale et quantité"
            mat-mini-fab
            color="accent"
            type="button"
            (click)="addTonnageDetailByTotalWeightAndQuantity()"
          >
            <mat-icon>add</mat-icon>
          </button>
        </div>
      </div>
    </form>
    <div class="mt-8 ml-8">
      <mat-checkbox (change)="reverseList()"
        >Inverser l'ordre d'affichage ?
      </mat-checkbox>
    </div>
    <mat-table [dataSource]="tonnage.details">
      <ng-container matColumnDef="type">
        <mat-header-cell fxLayoutAlign="center center" *matHeaderCellDef
          >Type</mat-header-cell
        >
        <mat-cell fxLayoutAlign="center center" *matCellDef="let tonnage">
          <span class="job-title">
            {{ tonnage.itemType.typeFamily.name }}
          </span>
        </mat-cell>
      </ng-container>
      <ng-container matColumnDef="weight">
        <mat-header-cell fxLayoutAlign="center center" *matHeaderCellDef
          >Poids</mat-header-cell
        >
        <mat-cell fxLayoutAlign="center center" *matCellDef="let tonnage">
          <mat-form-field appearance="outline" fxFlex="100">
            <input
              [(ngModel)]="tonnage.weight"
              matInput
              name="weight"
              type="number"
              (keyup.enter)="updateTonnageDetail(tonnage)"
            />
          </mat-form-field>
        </mat-cell>
      </ng-container>
      <ng-container matColumnDef="percentage">
        <mat-header-cell fxLayoutAlign="center center" *matHeaderCellDef
          >%</mat-header-cell
        >
        <mat-cell fxLayoutAlign="center center" *matCellDef="let tonnage">
          <mat-form-field appearance="outline" fxFlex="100">
            <mat-select name="percentageS" [(ngModel)]="tonnage.percentage">
              <mat-option
                *ngFor="let percentage of possiblePercentage"
                [value]="percentage"
              >
                {{ percentage }}
              </mat-option>
            </mat-select>
          </mat-form-field>
        </mat-cell>
      </ng-container>
      <ng-container matColumnDef="actions">
        <mat-header-cell
          fxLayoutAlign="center center"
          *matHeaderCellDef
        ></mat-header-cell>
        <mat-cell fxLayoutAlign="center center" *matCellDef="let tonnageDetails">
          <div
            fxHide.lt-md
            class="buttons-row"
            fxLayout="row wrap"
            fxLayoutAlign="space-between center"
          >
            <button
              [disabled]="tonnage.isValidated"
              mat-icon-button
              color="accent"
              class="mat-elevation-z1"
              (click)="updateTonnageDetail(tonnageDetails)"
              *ngIf="habilitation.canEdit()"
            >
              <mat-icon>edit</mat-icon>
            </button>
            <button
              [disabled]="tonnage.isValidated"
              mat-icon-button
              color="warn"
              class="mat-elevation-z1"
              (click)="deleteTonnageDetail(tonnageDetails)"
              *ngIf="habilitation.canDelete()"
            >
              <mat-icon>delete_outline</mat-icon>
            </button>
          </div>
          <div fxHide.gt-sm *ngIf="habilitation.canEdit()">
            <button mat-icon-button [matMenuTriggerFor]="actionsMenu">
              <mat-icon>more_horiz</mat-icon>
            </button>

            <mat-menu #actionsMenu="matMenu">
              <button
                mat-menu-item
                [disabled]="tonnage.isValidated"
                (click)="updateTonnageDetail(tonnageDetails)"
                *ngIf="habilitation.canEdit()"
              >
                <span><mat-icon color="accent">edit</mat-icon>Modifier</span>
              </button>
              <button
                mat-menu-item
                [disabled]="tonnage.isValidated"
                (click)="deleteTonnageDetail(tonnageDetails)"
                *ngIf="habilitation.canDelete()"
              >
                <span><mat-icon color="warn">delete_outline</mat-icon>Supprimer</span>
              </button>
            </mat-menu>
          </div>
        </mat-cell>
      </ng-container>
      <mat-header-row
        *matHeaderRowDef="tonnageDetailsdisplayedColumns"
      ></mat-header-row>
      <mat-row
        *matRowDef="let tonnage; columns: tonnageDetailsdisplayedColumns"
        class="activity"
        [hidden]="!tonnage.itemType.isCarcass || !tonnage.isRealWeight"
      >
      </mat-row>
    </mat-table>
  </mat-tab>
  <!-- ABATS -->
  <mat-tab label="Abats">
    <div class="content" *ngIf="habilitation.canEdit()">
      <form
        #gibletsForm="ngForm"
        name="tonnageGibletform"
        (ngSubmit)="addTonnageGibletDetail(gibletsForm)"
      >
        <div
          class="mat-elevation-z2 add-panel p-12"
          fxLayoutAlign="space-around center"
          fxLayout.lt-sm="column"
        >
          <div fxFlex="40">
            <mat-form-field appearance="outline" fxFlex="100">
              <mat-label>Type</mat-label>
              <mat-select
                class="custom-select"
                name="type"
                [(ngModel)]="newTonnageGibletDetails.itemType"
                required
              >
                <mat-option
                  *ngFor="let tonnageGiblet of tonnageGiblets"
                  [value]="tonnageGiblet"
                >
                  {{
                    tonnageGiblet.typeFamily.name +
                      "[" +
                      tonnageGiblet.name +
                      "]" +
                      " - PM (" +
                      tonnageGiblet.weight +
                      ")"
                  }}
                </mat-option>
              </mat-select>
            </mat-form-field>
          </div>
          <div fxFlex="25">
            <mat-form-field appearance="outline" fxFlex="100">
              <mat-label>Quantité</mat-label>
              <input
                matInput
                name="title"
                type="number"
                [(ngModel)]="newTonnageGibletDetails.quantity"
                required
              />
            </mat-form-field>
          </div>
          <div>
            <button
              [disabled]="tonnage.isValidated"
              mat-icon-button
              color="accent"
              class="mat-elevation-z1"
              type="submit"
            >
              <mat-icon>add</mat-icon>
            </button>
          </div>
        </div>
      </form>
    </div>
    <mat-table [dataSource]="tonnage.details">
      <ng-container matColumnDef="type">
        <mat-header-cell fxLayoutAlign="center center" *matHeaderCellDef
          >Type (Abats)</mat-header-cell
        >
        <mat-cell fxLayoutAlign="center center" *matCellDef="let tonnageGiblet">
          <span class="job-title">
            {{
              tonnageGiblet.itemType.typeFamily.name +
                " - " +
                tonnageGiblet.itemType.name
            }}
          </span>
        </mat-cell>
      </ng-container>
      <ng-container matColumnDef="weight">
        <mat-header-cell fxLayoutAlign="center center" *matHeaderCellDef
          >PM</mat-header-cell
        >
        <mat-cell fxLayoutAlign="center center" *matCellDef="let tonnageGiblet">
          {{ tonnageGiblet.weight }}
        </mat-cell>
      </ng-container>
      <ng-container matColumnDef="quantity">
        <mat-header-cell fxLayoutAlign="center center" *matHeaderCellDef
          >Quantité</mat-header-cell
        >
        <mat-cell fxLayoutAlign="center center" *matCellDef="let tonnageGiblet">
          <mat-form-field appearance="outline" fxFlex="100">
            <input
              [(ngModel)]="tonnageGiblet.quantity"
              matInput
              name="quantity"
              type="number"
            />
          </mat-form-field>
        </mat-cell>
      </ng-container>
      <ng-container matColumnDef="totale">
        <mat-header-cell fxLayoutAlign="center center" *matHeaderCellDef
          >TOTAL(Kg)</mat-header-cell
        >
        <mat-cell fxLayoutAlign="center center" *matCellDef="let tonnageGiblet">
          {{ geTotal(tonnageGiblet.weight, tonnageGiblet.quantity) }}
        </mat-cell>
      </ng-container>

      <ng-container matColumnDef="actions">
        <mat-header-cell
          fxLayoutAlign="center center"
          *matHeaderCellDef
        ></mat-header-cell>
        <mat-cell fxLayoutAlign="center center" *matCellDef="let tonnageGiblet">
          <div
            class="buttons-row"
            fxLayout="row wrap"
            fxLayoutAlign="space-between center"
            fxHide.lt-md
          >
            <button
              [disabled]="tonnage.isValidated"
              *ngIf="habilitation.canEdit()"
              mat-icon-button
              color="accent"
              class="mat-elevation-z1"
              (click)="updateTonnageDetail(tonnageGiblet)"
            >
              <mat-icon>edit</mat-icon>
            </button>
            <button
              [disabled]="tonnage.isValidated"
              *ngIf="habilitation.canDelete()"
              mat-icon-button
              color="warn"
              class="mat-elevation-z1"
              (click)="deleteTonnageDetail(tonnageGiblet)"
            >
              <mat-icon>delete_outline</mat-icon>
            </button>
          </div>
          <div fxHide.gt-sm *ngIf="habilitation.canEdit()">
            <button mat-icon-button [matMenuTriggerFor]="actionsMenu">
              <mat-icon>more_horiz</mat-icon>
            </button>

            <mat-menu #actionsMenu="matMenu">
              <button
                mat-menu-item
                [disabled]="tonnage.isValidated"
                (click)="updateTonnageDetail(tonnageGiblet)"
                *ngIf="habilitation.canEdit()"
              >
                <span><mat-icon color="accent">edit</mat-icon>Modifier</span>
              </button>
              <button
                mat-menu-item
                [disabled]="tonnage.isValidated"
                (click)="deleteTonnageDetail(tonnageGiblet)"
                *ngIf="habilitation.canDelete()"
              >
                <span><mat-icon color="warn">delete_outline</mat-icon>Supprimer</span>
              </button>
            </mat-menu>
          </div>
        </mat-cell>
      </ng-container>
      <mat-header-row
        *matHeaderRowDef="tonnageGibletDisplayedColumns"
      ></mat-header-row>
      <mat-row
        *matRowDef="let tonnageGiblet; columns: tonnageGibletDisplayedColumns"
        class="activity"
        [hidden]="tonnageGiblet.itemType.isCarcass"
      >
      </mat-row>
    </mat-table>
  </mat-tab>
</mat-tab-group>
