<div *ngIf="!discussion" fxLayout="column" fxLayoutAlign="center center" fxFlex>
  <mat-icon class="s-128 mb-16 select-message-icon hint-text"
    [@animate]="{ value: '*', params: { delay: '300ms', scale: '0.2' } }">
    email
  </mat-icon>
  <span class="select-message-text hint-text" fxLayoutAlign="center center"
    [@animate]="{ value: '*', params: { delay: '400ms' } }">
    <span>Veuillez sélectionner une discussion dans la liste</span>
  </span>
</div>

<div *ngIf="discussion" class="p-12">
  <div class="mail-header" fxLayout="row" fxLayoutAlign="space-between center">
    <div>
      <div class="subject">{{ discussion.subject }}</div>
      <div class="labels mt-8" fxLayout="row wrap">
        <div class="label" fxLayout="row" fxLayoutAlign="start center">
          <div class="label-color" style="background-color: #039be5;"></div>
          <div class="label-title">
            {{ discussion.department.name | uppercase }}
          </div>
        </div>
        <div class="label" fxLayout="row" fxLayoutAlign="start center">
          <div class="label-color" [ngStyle]="{
              'background-color': discussion.isClosed ? '#91dc5b' : '#ffd31a'
            }"></div>
          <div class="label-title">
            {{ discussion.isClosed ? "Clôturée" : "En cours" }}
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="mail-content">
    <div class="info" fxLayout="row" fxLayoutAlign="space-between start">
      <div fxFlex fxLayout="column" fxLayoutAlign="start start">
        <div fxLayout="row" fxLayoutAlign="start start">
          <div>
            <div class="avatar accent">{{ discussion.name[0] }}</div>
          </div>
          <div fxLayout="column" fxLayoutAlign="start start">
            <div class="name">
              {{ discussion.name | uppercase }}
            </div>

            <div class="to" fxLayout="row" fxLayoutAlign="start center">
              <div class="to-text">{{ discussion.date | date:'dd/MM/yyyy' }}</div>
            </div>
          </div>
        </div>

        <a class="toggle-details" (click)="showDetails = !showDetails">
          <span *ngIf="!showDetails">Afficher les détails</span>
          <span *ngIf="showDetails">Cacher les détails</span>
        </a>

        <div *ngIf="showDetails" class="details" fxLayout="row" fxLayoutAlign="start start">
          <div fxLayout="column">
            <span class="title">De :</span>
            <span class="title">A :</span>
            <span class="title">Le :</span>
          </div>

          <div fxLayout="column">
            <span class="detail">{{ discussion.email }}</span>
            <span class="detail">contact@avs.fr</span>
            <span class="detail">{{ discussion.date | date:'dd/MM/yyyy hh:mm' }}</span>
          </div>
        </div>
      </div>
      <button mat-icon-button [matMenuTriggerFor]="moreMenu" aria-label="More" (click)="$event.stopPropagation()"
        *ngIf="!discussion.isClosed && habilitation.isAdmin()">
        <mat-icon>more_vert</mat-icon>
      </button>

      <mat-menu #moreMenu="matMenu">
        <button mat-menu-item aria-label="close discussion" (click)="closeDiscussion()">
          <mat-icon>check</mat-icon>
          <span>Clôturer la discussion</span>
        </button>
      </mat-menu>
    </div>

    <div [innerHTML]="discussion.content"></div>
    <div *ngIf="discussion.attachment.fileName" class="mail-attachments">
      <div class="title">
        <span>Document joint</span>
      </div>
      <div class="attachment-list" fxLayout="row wrap">
        <div class="attachment" fxLayout="column">
          <a style="cursor: pointer;"  (click)="downloadAttachment(discussion.attachment)"> {{ discussion.attachment.fileName }} </a>
        </div>
      </div>
    </div>
  </div>
  <div fxLayout="column">
    <div *ngIf="discussion.items.length !== 0">
      <div *ngFor="let item of discussion.items">
        <div fxLayout="column">
          <div class="comment-panel p-16" fxLayout="row" [innerHTML]="item.content">
          </div>
          <div fxLayoutAlign="end" class="pt-4"><span class="font-weight-700 mb-8 px-4">{{item.from}}</span><span class="px-4">{{item.date |date:'dd/MM/yyyy hh:mm'}}</span></div>
          <div *ngIf="item.attachments.length !== 0" class="mail-attachments" fxLayout="column">
            <div class="title">Documents joints</div>
            <div class="attachment-list" fxLayout="row wrap">
              <div *ngFor="let attachment of item.attachments" fxLayout="row">
                <a style="cursor: pointer;" (click)="downloadAttachment(attachment)" class="pr-8"> {{ attachment.fileName }} </a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- REPLY FORM -->
    <div *ngIf="discussion.isClosed; else notClosed" fxLayout="row" fxLayoutAlign="center center">
      <button mat-raised-button color="primary">
        Cette discussion est clôturée
      </button>
    </div>
    <ng-template #notClosed>
      <div *ngIf="habilitation.canEdit()" class="p-16">
        <div fxLayout="row" class="mt-8">
          <mat-form-field appearance="outline" fxFlex="100">
            <mat-label>Votre message ici</mat-label>
            <textarea class="m-8" [(ngModel)]="replyContent" matInput rows="6"></textarea>
          </mat-form-field>
        </div>
        <div fxLayout="row wrap" class="m-8" fxLayoutAlign="space-between center">
          <input hidden #file type="file" name="file" id="file" class="inputfile" multiple="multiple"
            (change)="getAttachment(file.files)" />
          <button mat-fab color="warn" type="button" (click)="file.click()">
            <mat-icon>attachment</mat-icon>
          </button>
          <div *ngIf="attachedFileName != ''" fxLayout="row" fxLayoutAlign="center center">
            <span (click)="downloadAttachment()">{{ attachedFileName }}</span>
            <button mat-icon-button color="warn" (click)="removeAttachment()">
              <mat-icon>close</mat-icon>
            </button>
          </div>
          <button mat-raised-button color="accent" (click)="addDiscussionItem()">
            Répondre
          </button>
        </div>
      </div>

    </ng-template>
  </div>



</div>
