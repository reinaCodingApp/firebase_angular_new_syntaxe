<!-- Activities Display Templates-->
<!-- PER EMPLOYEE MODE -->
<ng-template #searchPanel>
  <div class="  flex flex-col sm:flex-row sm:items-end items-end justify-between">
    <div class="ml-auto">
      <div class="flex flex-row py-1 bg-white border-2 border-gray-100 rounded-full mr-3 w-140">
        <button mat-icon-button class="secondary-text">
          <mat-icon>search</mat-icon>
        </button>
        <input placeholder="Filtrer les salariés par site" name="search" [(ngModel)]="filterValue"
          (keyup.enter)="onFilterBySite()" />
      </div>
    </div>
  </div>

</ng-template>
<ng-template #perEmployeeDisplay>
  <div *ngIf="!displaySimpleList" class="p-2">
    <div *ngFor="let activityPerEmployee of activitiesPerEmployee">
      <div class="p-4 text-3xl text-fuchsia-900 font-semibold shadow-md bg-white max-w-max mb-2 mt-4">
        {{ activityPerEmployee.employee.fullName }}
      </div>
      <div *ngFor="
            let activityPerWeek of activityPerEmployee.activitiesPerWeek;
            index as i">
        <div class="flex flex-row mb-2">
          <div class="p-2 flex flex-col items-center justify-evenly  bg-purple-900">
            <div class="text-green-400">Semaine</div>
            <div class="text-4xl text-green-400">
              {{ activityPerWeek.weekNumber }}
            </div>
            <div class="text-gray-400">
              {{ activityPerWeek.totalWorkTimeString }}
            </div>
          </div>
          <table mat-table [dataSource]="activityPerWeek.activities" class="w-full">
            <ng-container matColumnDef="day">
              <mat-header-cell *matHeaderCellDef class="w-2.5/12 text-left text-xs">DATE</mat-header-cell>
              <mat-cell *matCellDef="let activity" class="text-black text-left text-sm break-all pl-2">
                <span>
                  {{ activity.day }}
                </span>
              </mat-cell>
            </ng-container>
            <ng-container matColumnDef="startTime">
              <mat-header-cell *matHeaderCellDef class="w-1/12 text-sm">DÉBUT</mat-header-cell>
              <mat-cell *matCellDef="let activity" class="text-black text-sm pl-2">
                <span>
                  {{ activity.startTime }}
                </span>
              </mat-cell>
            </ng-container>
            <ng-container matColumnDef="totalBreakTimeString">
              <mat-header-cell *matHeaderCellDef class="w-1/12    text-xs">PAUSES</mat-header-cell>
              <mat-cell *matCellDef="let activity" class="text-black  text-sm">
                <span satPopoverAnchor #breaksAnchor="satPopoverAnchor" (mouseenter)="breaksPopover.open()"
                  (mouseleave)="breaksPopover.close()">
                  {{ activity.totalBreakTimeString }}
                </span>
                <sat-popover #breaksPopover [anchor]="breaksAnchor" horizontalAlign="after">
                  <div class="bg-white p-2 rounded-lg">
                    {{activity.breaksString}}
                  </div>
                </sat-popover>
              </mat-cell>
            </ng-container>
            <ng-container matColumnDef="endTime">
              <mat-header-cell *matHeaderCellDef class="w-1/12 text-sm">FIN</mat-header-cell>
              <mat-cell *matCellDef="let activity" class="text-black  text-sm">
                <span>
                  {{ activity.endTime }}
                </span>
              </mat-cell>
            </ng-container>
            <ng-container matColumnDef="totalWorkedTimeString">
              <mat-header-cell *matHeaderCellDef class="w-1/12  text-xs">TOTAL HEURES</mat-header-cell>
              <mat-cell *matCellDef="let activity" class=" text-sm text-black">
                <span>
                  {{ activity.totalWorkedTimeString }}
                </span>
              </mat-cell>
            </ng-container>
            <ng-container matColumnDef="site">
              <mat-header-cell *matHeaderCellDef class="w-2/12 text-center">SITE</mat-header-cell>
              <mat-cell *matCellDef="let activity" class="text-black text-sm">
                {{ activity.site.name }}
              </mat-cell>
            </ng-container>
            <ng-container matColumnDef="bonusString">
              <mat-header-cell *matHeaderCellDef class="w-1/12 text-center ">PRIME</mat-header-cell>
              <mat-cell *matCellDef="let activity" class="text-black">
                <span>
                  {{ activity.bonusString }}
                </span>
              </mat-cell>
            </ng-container>
            <ng-container matColumnDef="manuallyCreated">
              <mat-header-cell *matHeaderCellDef class="w-0.5/12 text-sm ">[T]</mat-header-cell>
              <mat-cell *matCellDef="let activity" class="text-sm text-black ">
                <span *ngIf="activity.activityType == 1">
                  <mat-icon class="text-black text-lg">
                    {{
                    activity.manuallyCreated
                    ? "keyboard"
                    : "stay_current_portrait"
                    }}
                  </mat-icon>
                </span>
              </mat-cell>
            </ng-container>
            <ng-container matColumnDef="dayCounter">
              <mat-header-cell *matHeaderCellDef class="w-0.5/12 text-xs">J</mat-header-cell>
              <mat-cell *matCellDef="let activity" class="text-sm text-black">
                <span>
                  {{ activity.dayCounter > 0 ? activity.dayCounter : "" }}
                </span>
              </mat-cell>
            </ng-container>
            <ng-container matColumnDef="title">
              <mat-header-cell *matHeaderCellDef class="w-1/12 text-xs  md:hidden lg:hidden">REMARQUE</mat-header-cell>
              <mat-cell *matCellDef="let activity" class="text-sm text-black md:hidden lg:hidden">
                <span>
                  {{ activity.title }}
                </span>
              </mat-cell>
            </ng-container>
            <ng-container matColumnDef="actions">
              <mat-header-cell class="actions-header" class="w-0.5/12 text-sm" *matHeaderCellDef></mat-header-cell>
              <mat-cell class="actions-cell" *matCellDef="let activity" class="text-sm">
                <span *ngIf="habilitation.canEdit()">
                  <button mat-button class="p-0" [matMenuTriggerFor]="actionsMenu">
                    <mat-icon class="text-white">more_horiz</mat-icon>
                  </button>
                  <mat-menu #actionsMenu="matMenu">
                    <button mat-menu-item (click)="updateActivity(activity)" [disabled]="activity.activityType != 1">
                      <mat-icon color="accent">edit</mat-icon>
                      Modifier
                    </button>
                    <button mat-menu-item (click)="updateBonusActivity(activity)"
                      [disabled]="activity.activityType != 1">
                      <mat-icon color="primary">euro_symbol</mat-icon>
                      Primes
                    </button>
                    <button mat-menu-item (click)="updateBreaksActivity(activity)"
                      [disabled]="activity.activityType != 1">
                      <mat-icon color="primary">local_cafe</mat-icon>
                      Pauses
                    </button>
                    <button mat-menu-item (click)="deleteActivity(activity)" [disabled]="
                            (activity.activityType != 1 &&
                              activity.activityType != 2 &&
                              activity.activityType != 5)
                          " *ngIf="habilitation.canDelete()">
                      <mat-icon color="warn">delete_outline</mat-icon>Supprimer
                    </button>
                  </mat-menu>
                </span>
              </mat-cell>
            </ng-container>
            <mat-header-row *matHeaderRowDef="displayedColumns" [hidden]="i > 0"></mat-header-row>
            <mat-row *matRowDef="let activity; columns: displayedColumns" class="activity" matRipple
              [class.bg-green-400]="
                    activity.activityType === 1 && activity.activityState === 3
                  " [class.bg-yellow-500]="
                    activity.activityType === 1 && activity.activityState < 3
                  " [class.bg-red-400]="
                    activity.activityType === 2 ||
                    activity.activityType === 9 ||
                    activity.activityType === 4
                  " [class.bg-gray-400]="activity.activityType === 0"
              [class.bg-purple-500]="activity.activityType === 5" [class.bg-blue-500]="activity.activityType === 23">
            </mat-row>
          </table>
        </div>

      </div>
    </div>
  </div>
</ng-template>
<!-- LIST MODE -->
<ng-template #simpleListDisplay>
  <div *ngIf="displaySimpleList" class="p-2">
    <mat-table [dataSource]="activities" matSort (matSortChange)="sortActivities($event)">
      <ng-container matColumnDef="fullName">

        <mat-header-cell *matHeaderCellDef mat-sort-header="fullName" class="w-2/6 p-2">SALARIE</mat-header-cell>
        <mat-cell *matCellDef="let activity" class="text-black">
          {{ activity.employee.fullName }}
        </mat-cell>
      </ng-container>
      <ng-container matColumnDef="day">

        <mat-header-cell *matHeaderCellDef mat-sort-header="day" class="w-1/6">DATE</mat-header-cell>
        <mat-cell *matCellDef="let activity" class="text-black">
          <span>
            {{ activity.startDate }}
          </span>
        </mat-cell>
      </ng-container>
      <ng-container matColumnDef="startTime">

        <mat-header-cell *matHeaderCellDef mat-sort-header="startTime" class="w-1/6">DÉBUT</mat-header-cell>
        <mat-cell *matCellDef="let activity" class="text-black">
          <span>
            {{ activity.startTime }}
          </span>
        </mat-cell>
      </ng-container>
      <ng-container matColumnDef="totalBreakTimeString">

        <mat-header-cell *matHeaderCellDef mat-sort-header="totalBreakTime">PAUSES</mat-header-cell>
        <mat-cell *matCellDef="let activity" class="text-black">
          <span satPopoverAnchor  #breaksAnchor="satPopoverAnchor" (mouseenter)="breaksPopover.open()"
            (mouseleave)="breaksPopover.close()">
            {{ activity.totalBreakTimeString }}
          </span>
          <sat-popover  #breaksPopover [anchor]="breaksAnchor" horizontalAlign="after">
            <div class="popover-info mat-elevation-z8 font-size-14">
              {{activity.breaksString}}
            </div>
          </sat-popover>
        </mat-cell>
      </ng-container>
      <ng-container matColumnDef="endTime">

        <mat-header-cell *matHeaderCellDef mat-sort-header="endTime">FIN</mat-header-cell>
        <mat-cell *matCellDef="let activity" class="text-black">
          <span>
            {{ activity.endTime }}
          </span>
        </mat-cell>
      </ng-container>
      <ng-container matColumnDef="totalWorkedTimeString">

        <mat-header-cell *matHeaderCellDef mat-sort-header="totalWorkedTime" >TOTAL HEURES
        </mat-header-cell>
        <mat-cell *matCellDef="let activity" class="text-black ">
          <span>
            {{ activity.totalWorkedTimeString }}
          </span>
        </mat-cell>
      </ng-container>
      <ng-container matColumnDef="site">

        <mat-header-cell *matHeaderCellDef mat-sort-header="site" class="text-xs">SITE</mat-header-cell>
        <mat-cell *matCellDef="let activity" class="text-black ">
          <span class="text-sm">
            {{ activity.site.name }}
          </span>
        </mat-cell>
      </ng-container>
      <ng-container matColumnDef="bonusString">

        <mat-header-cell *matHeaderCellDef>PRIME</mat-header-cell>
        <mat-cell *matCellDef="let activity" class="text-black">
          <span>
            {{ activity.bonusString }}
          </span>
        </mat-cell>
      </ng-container>
      <ng-container matColumnDef="manuallyCreated">

        <mat-header-cell *matHeaderCellDef>[T]</mat-header-cell>
        <mat-cell *matCellDef="let activity">
          <span *ngIf="activity.activityType == 1">
            <mat-icon class="text-black text-lg">
              {{
              activity.manuallyCreated
              ? "keyboard"
              : "stay_current_portrait"
              }}
            </mat-icon>
          </span>
        </mat-cell>
      </ng-container>
      <ng-container matColumnDef="dayCounter">

        <mat-header-cell *matHeaderCellDef>J</mat-header-cell>
        <mat-cell *matCellDef="let activity" class="text-black">
          <span>
            {{ activity.dayCounter > 0 ? activity.dayCounter : "" }}
          </span>
        </mat-cell>
      </ng-container>
      <ng-container matColumnDef="title">

        <mat-header-cell *matHeaderCellDef>REMARQUE</mat-header-cell>
        <mat-cell *matCellDef="let activity" class="text-black ">
          <span>
            {{ activity.title }}
          </span>
        </mat-cell>
      </ng-container>
      <ng-container matColumnDef="actions">

        <mat-header-cell class="actions-header" *matHeaderCellDef>ACTIONS</mat-header-cell>
        <mat-cell class="actions-cell" *matCellDef="let activity">
          <span *ngIf="habilitation.canEdit()">
            <button mat-button [matMenuTriggerFor]="actionsMenu">
              <mat-icon class="text-black">more_horiz</mat-icon>
            </button>
            <mat-menu #actionsMenu="matMenu">
              <button mat-menu-item (click)="updateActivity(activity)" [disabled]="activity.activityType != 1">
                <mat-icon color="accent">edit</mat-icon>
                Modifier
              </button>
              <button mat-menu-item (click)="updateBonusActivity(activity)" [disabled]="activity.activityType != 1">
                <mat-icon color="primary">euro_symbol</mat-icon>
                Primes
              </button>
              <button mat-menu-item (click)="updateBreaksActivity(activity)" [disabled]="activity.activityType != 1">
                <mat-icon color="primary">local_cafe</mat-icon>
                Pauses
              </button>
              <button mat-menu-item (click)="deleteActivity(activity)" [disabled]="
                      (activity.activityType != 1 &&
                        activity.activityType != 2 &&
                        activity.activityType != 5)
                    " *ngIf="habilitation.canDelete()">
                <mat-icon color="warn">delete_outline</mat-icon>Supprimer
              </button>
            </mat-menu>
          </span>
        </mat-cell>
      </ng-container>
      <mat-header-row *matHeaderRowDef="displayedColumns2"></mat-header-row>
      <mat-row *matRowDef="let activity; columns: displayedColumns2" class="activity" matRipple [class.bg-green-400]="
              activity.activityType === 1 && activity.activityState === 3
            " [class.bg-yellow-500]="
              activity.activityType === 1 && 
              activity.activityState < 3
            " [class.bg-red-400]="
              activity.activityType === 2 ||
              activity.activityType === 9 ||
              activity.activityType === 4
            " [class.bg-gray-400]="activity.activityType === 0" [class.bg-purple-500]="activity.activityType === 5"
        [class.g-blue-500]="activity.activityType === 23">
      </mat-row>
    </mat-table>

  </div>
</ng-template>

<!-- AVS Workers Template -->
<ng-container>
  <!-- Simple User Display -->
  <div class="mt-4">
    <ng-container *ngTemplateOutlet="searchPanel"></ng-container>
    <ng-container *ngTemplateOutlet="perEmployeeDisplay"> </ng-container>
    <ng-container *ngTemplateOutlet="simpleListDisplay"> </ng-container>
  </div>
</ng-container>